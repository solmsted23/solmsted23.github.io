<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D3 and Plot Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6.10/dist/plot.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6.10/dist/plot.min.css">
  <style>
    body {
      font-family: sans-serif;
    }
    svg {
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>

<h2>Custom D3 Map</h2>
<div id="d3-map"></div>

<h2>Plot.js Map</h2>
<div id="plot-map"></div>

<script>

// Utility: Basic Legend function for color scale
function Legend(color, {title, width = 320, tickSize = 6} = {}) {
  const svg = d3.create("svg")
      .attr("width", width)
      .attr("height", 44)
      .attr("viewBox", [0, 0, width, 44])
      .style("overflow", "visible");

  const x = Object.assign(d3.scaleLinear()
      .domain(color.domain())
      .rangeRound([0, width]), {
    ticks: color.ticks ? color.ticks(10) : d3.ticks(...color.domain(), 10),
    tickFormat: d3.format(".0f")
  });

  svg.append("g")
    .selectAll("rect")
    .data(d3.pairs(color.range().map(d => color.invertExtent(d))))
    .join("rect")
      .attr("x", ([a]) => x(a))
      .attr("width", ([a, b]) => x(b) - x(a))
      .attr("height", 10)
      .attr("fill", ([a, b]) => color(a));

  svg.append("g")
      .attr("transform", `translate(0,10)`)
      .call(d3.axisBottom(x).tickSize(tickSize).tickFormat(x.tickFormat))
      .call(g => g.select(".domain").remove());

  svg.append("text")
      .attr("y", -10)
      .attr("x", 0)
      .attr("text-anchor", "start")
      .attr("font-weight", "bold")
      .text(title);

  return svg.node();
}

Promise.all([
  d3.csv("unemployment-x.csv", d => ({id: d.id, rate: +d.rate})),
  fetch("counties-albers-10m.json").then(res => res.json())
]).then(([data, us]) => {
  const color = d3.scaleQuantize([1, 10], d3.schemeBlues[9]);
  const path = d3.geoPath();
  const valuemap = new Map(data.map(d => [d.id, d.rate]));

  const counties = topojson.feature(us, us.objects.counties);
  const states = topojson.feature(us, us.objects.states);
  const statemap = new Map(states.features.map(d => [d.id, d]));
  const statemesh = topojson.mesh(us, us.objects.states, (a, b) => a !== b);

  // Custom D3 Map
  const svg = d3.create("svg")
      .attr("width", 975)
      .attr("height", 610)
      .attr("viewBox", [0, 0, 975, 610])
      .attr("style", "max-width: 100%; height: auto;");

  svg.append("g")
      .attr("transform", "translate(610,20)")
      .append(() => Legend(color, {title: "Unemployment rate (%)", width: 260}));

  svg.append("g")
    .selectAll("path")
    .data(counties.features)
    .join("path")
      .attr("fill", d => color(valuemap.get(d.id)))
      .attr("d", path)
    .append("title")
      .text(d => {
        const state = statemap.get(String(d.id).slice(0, 2));
        return `${d.properties.name || "Unknown"}, ${state?.properties.name || "Unknown"}\n${valuemap.get(d.id)}%`;
      });

  svg.append("path")
      .datum(statemesh)
      .attr("fill", "none")
      .attr("stroke", "white")
      .attr("stroke-linejoin", "round")
      .attr("d", path);

  document.getElementById("d3-map").appendChild(svg.node());

  // Plot.js Map
  const plot = Plot.plot({
    projection: "identity",
    width: 975,
    height: 610,
    color: {
      scheme: "Blues",
      type: "quantize",
      n: 9,
      domain: [1, 10],
      label: "Unemployment rate (%)",
      legend: true
    },
    marks: [
      Plot.geo(
        counties,
        {
          fill: (map => d => map.get(d.id))(new Map(data.map(d => [d.id, d.rate])))
        }
      ),
      Plot.geo(
        topojson.mesh(us, us.objects.states, (a, b) => a !== b),
        {stroke: "white"}
      )
    ]
  });

  document.getElementById("plot-map").appendChild(plot);

});
</script>

</body>
</html>