<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dish Sentiment Analyzer</title>
  <style>
    textarea { width: 100%; height: 200px; }
    pre { background: #f0f0f0; padding: 1em; overflow-x: auto; }
    .container { max-width: 900px; margin: auto; }
    #status { font-weight: bold; margin-top: 10px; }
    #spinner {
      display: none;
      margin-left: 10px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #555;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dish Sentiment Analyzer</h1>

    <label for="jsonInput">Paste Yelp Reviews (JSON lines):</label>
    <textarea id="jsonInput" placeholder='Paste JSON objects here (one per line)'></textarea>

    <label for="dishInput">List of Dishes (one per line):</label>
    <textarea id="dishInput" placeholder="guacamole\ntacos\nenchiladas"></textarea>

    <label for="bizMapInput">Business Name Mapping (JSON, one per line):</label>
    <textarea id="bizMapInput" placeholder='{"business_id": "abc123", "name": "Taco Palace"}'></textarea>

    <button onclick="startProcessing()">Process</button>
    <div id="status">Idle</div>
    <div id="spinner"></div>

    <h2>Results</h2>
    <pre id="output"></pre>
  </div>

  <script>
    function startProcessing() {
      document.getElementById("status").textContent = "In progress...";
      document.getElementById("spinner").style.display = "inline-block";

      setTimeout(() => {
        processData();
        document.getElementById("status").textContent = "Done!";
        document.getElementById("spinner").style.display = "none";
      }, 10);
    }

    function processData() {
      const reviewsRaw = document.getElementById('jsonInput').value.trim().split('\n');
      const dishesRaw = document.getElementById('dishInput').value.trim().split('\n');
      const bizMapRaw = document.getElementById('bizMapInput').value.trim().split('\n');
      
      const reviews = [];
      const dishes = dishesRaw.map(d => d.trim()).filter(Boolean);
      const bizNames = {};
      const dishStats = {};
      const bizStats = {};
      
      for (let line of reviewsRaw) {
        try {
          const data = JSON.parse(line);
          reviews.push({
            review: data.text || '',
            stars: data.stars || 0,
            useful: (data.votes && data.votes.useful) || 0,
            business_id: data.business_id || ''
          });
        } catch (e) { console.warn("Bad review JSON", e); }
      }

      for (let line of bizMapRaw) {
        try {
          const data = JSON.parse(line);
          if (data.business_id && data.name) bizNames[data.business_id] = data.name;
        } catch (e) { console.warn("Bad business map JSON", e); }
      }

      dishes.forEach(d => dishStats[d] = [0, 0]);

      for (const r of reviews) {
        for (const dish of dishes) {
          if (r.review.toLowerCase().includes(dish.toLowerCase())) {
            let score = r.stars;
            if (r.stars === 1 || r.stars === 2) {
              score *= (1 - r.useful * 0.005);
            } else if (r.stars === 4 || r.stars === 5) {
              score *= (1 + r.useful * 0.005);
            }

            dishStats[dish][0] += score;
            dishStats[dish][1] += 1;

            if (!bizStats[r.business_id]) bizStats[r.business_id] = {};
            if (!bizStats[r.business_id][dish]) bizStats[r.business_id][dish] = [0, 0];
            bizStats[r.business_id][dish][0] += r.stars;
            bizStats[r.business_id][dish][1] += 1;
          }
        }
      }

      let output = '=== Overall Dish Ratings ===\n';
      const overall = Object.entries(dishStats)
        .filter(([_, [_, count]]) => count > 0)
        .map(([dish, [score, count]]) => [dish, score / count, count])
        .sort((a, b) => b[1] - a[1]);

      for (const [dish, avg, count] of overall) {
        output += `${dish}: avg score = ${avg.toFixed(2)}, count = ${count}\n`;
      }

      output += '\n=== Business-specific Dish Ratings ===\n';
      for (const [bizId, dishes] of Object.entries(bizStats)) {
        const name = bizNames[bizId] || bizId;
        output += `\nBusiness: ${name}\n`;
        for (const [dish, [score, count]] of Object.entries(dishes)) {
          const avg = score / count;
          output += `  ${dish}: avg score = ${avg.toFixed(2)}, count = ${count}\n`;
        }
      }

      document.getElementById('output').textContent = output;
    }
  </script>
</body>
</html>