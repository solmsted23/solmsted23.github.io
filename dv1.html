<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>US County Unemployment Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    .slider-container {
      margin: 20px;
      text-align: center;
    }
    .annotation-note-label {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">US County Unemployment Rate by Year</h2>
  <div class="slider-container">
    <input type="range" min="2007" max="2021" value="2007" step="1" id="yearSlider">
    <label for="yearSlider" id="yearLabel">2007</label>
  </div>
  <svg id="map" width="960" height="600"></svg>

  <script>
    const width = 960, height = 600;
    const svg = d3.select("#map");
    const path = d3.geoPath();
    const color = d3.scaleQuantize()
      .range(d3.schemeBlues[9]);

    let unemploymentData = {};
    let counties, us;

    // Load all data files
    Promise.all([
      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json"),
      d3.csv("jobs_2007-2021_2.csv", d => ({
        fips: +d.FIPS,
        year: +d.Year,
        rate: +d.UnemploymentRate,
        county: d.County,
        state: d.State
      }))
    ]).then(([topology, data]) => {
      // Prepare data: group by year
      data.forEach(d => {
        if (!unemploymentData[d.year]) unemploymentData[d.year] = {};
        unemploymentData[d.year][d.fips] = d;
      });

      us = topology;
      counties = topojson.feature(us, us.objects.counties).features;

      updateMap(2007); // Initial draw

      // Add listener to slider
      d3.select("#yearSlider").on("input", function () {
        const year = +this.value;
        d3.select("#yearLabel").text(year);
        updateMap(year);
      });
    });

    function updateMap(year) {
      const yearData = unemploymentData[year];

      // Extract rates and find max for annotation
      const rates = Object.values(yearData).map(d => d.rate);
      color.domain(d3.extent(rates));

      const maxEntry = d3.max(Object.values(yearData), d => d.rate);
      const highest = Object.values(yearData).filter(d => d.rate === maxEntry)[0];

      // JOIN counties and unemployment rate
      svg.selectAll("path")
        .data(counties)
        .join("path")
        .attr("d", path)
        .attr("fill", d => {
          const record = yearData[d.id];
          return record ? color(record.rate) : "#ccc";
        })
        .attr("stroke", "#fff")
        .attr("stroke-width", 0.5);

      // Remove previous annotations
      svg.selectAll(".annotation-group").remove();

      // Add annotation for highest unemployment county
      if (highest) {
        const countyFeature = counties.find(c => c.id == highest.fips);
        if (countyFeature) {
          const centroid = path.centroid(countyFeature);
          const annotations = [
            {
              note: {
                label: `${highest.county}, ${highest.state}: ${highest.rate}%`,
                title: `Highest Unemployment`
              },
              x: centroid[0],
              y: centroid[1],
              dy: -30,
              dx: 30
            }
          ];

          const makeAnnotations = d3.annotation()
            .annotations(annotations);

          svg.append("g")
            .attr("class", "annotation-group")
            .call(makeAnnotations);
        }
      }
    }
  </script>
</body>
</html>